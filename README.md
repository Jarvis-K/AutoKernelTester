# AutoKernelTester

本目录包含一套用于 **PyTorch 算子精度测试** 的技能，帮助你自动化地对算子进行分析、测试规划、编写验证和生成报告。

---

## 🎯 核心功能

1. **分析算子文件**：识别 CPU/NPU 入口函数，提取 `__main__` 测试逻辑
2. **规划测试范围**：与用户确认测试用例覆盖
3. **编写并验证**：生成测试文件，复现原 `__main__` 测试
4. **扩展测试**：添加更多用例，导出 CSV，生成报告

---

## 📁 技能目录

```
.claude/skills/
├── test-op/              # 🎮 主入口
├── analyze-operator/     # 📖 阶段1：分析算子
├── plan-and-confirm/     # 📋 阶段2：规划并确认
├── write-and-verify/     # ✍️ 阶段3：编写并验证
└── extend-and-report/    # 📊 阶段4：扩展测试并报告
```

---

## 🚀 快速开始

```
/test-op <算子文件路径>
```

触发完整的四阶段流程：

```
分析 → 规划确认 → 编写验证 → 扩展报告
```

---

## 📖 工作流程

```
┌─────────────────┐
│  阶段 1：分析    │ → 识别入口函数 + 提取 __main__
│  /analyze-operator│
└────────┬────────┘
         │ 用户确认 ✓
         ▼
┌─────────────────┐
│  阶段 2：规划    │ → 生成 logs/test_plan.md
│  /plan-and-confirm│
└────────┬────────┘
         │ 用户批准 ✓
         ▼
┌─────────────────┐
│  阶段 3：编写验证 │ → 生成 test_<opname>.py
│  /write-and-verify│   循环验证直至复现原测试
└────────┬────────┘
         │ 用户确认 ✓
         ▼
┌─────────────────┐
│  阶段 4：扩展报告 │ → 导出 CSV + logs/test_report.md
│  /extend-and-report│
└─────────────────┘
```

---

## 🔑 核心设计：输入抽象化

测试文件采用**参数化设计**，不同测试仅改变配置：

```python
def make_inputs(**config):
    """统一输入构造，所有参数都可配置"""
    pass

TEST_CONFIGS = [
    {"name": "baseline", ...},  # 复现 __main__
    {"name": "small", ...},     # 扩展用例
]
```

---

## 📂 产物汇总

| 阶段 | 产物 | 说明 |
|------|------|------|
| 规划 | `logs/test_plan.md` | 测试计划 |
| 编写 | `test_<opname>.py` | 测试文件 |
| 报告 | `logs/test_report.md` | 测试报告 |
| 报告 | `results_<opname>_<ts>.csv` | 详细结果 |

---

## ⚠️ 注意事项

> [!CAUTION]
> **必须前台交互式执行**
> 
> - 每个阶段完成后等待用户确认
> - 不跳过阶段
> - Baseline 必须先通过才能扩展

---

## 🔧 容差策略

| dtype | atol | rtol |
|-------|------|------|
| fp32 | 1e-6 | 1e-6 |
| fp16 | 1e-2 | 1e-2 |
| bf16 | 2e-2 | 2e-2 |
