---
name: test-op
description: PyTorch 算子精度测试入口 - 路由到 restructure、plan、execute 技能
---

# 算子精度测试

> [!CAUTION]
> **必须前台交互式执行 - 禁止后台运行**
> 
> 执行此技能时必须：
> 1. 在前台逐步执行每个阶段
> 2. 每个阶段完成后**停止并等待用户确认**
> 3. 所有命令输出对用户可见
> 4. 用户可随时中断或提供反馈

---

## 工作流程

```
/test-op [算子文件]
    │
    ▼
┌─────────────────────────────────────┐
│  阶段 1：重构                        │
│  → /restructure-operator            │
│  → 生成 test_<opname>.py + 验证     │
│  → 🔴 停止，请求用户确认            │
└─────────────────────────────────────┘
    │ 用户确认 ✓
    ▼
┌─────────────────────────────────────┐
│  阶段 2：规划                        │
│  → /plan-operator-test              │
│  → 生成测试计划                     │
│  → 🔴 停止，请求用户批准            │
└─────────────────────────────────────┘
    │ 用户批准 ✓
    ▼
┌─────────────────────────────────────┐
│  阶段 3：执行                        │
│  → /execute-operator-test           │
│  → 运行测试 + 导出 CSV + 报告       │
│  → 🔴 展示结果，询问后续            │
└─────────────────────────────────────┘
```

---

## 用户交互模式

### 每阶段结束时的标准询问

**阶段 1 完成后：**
```
✅ 重构完成。请查看：
- 测试文件：test_<算子名>.py
- 校验 CSV：golden_results_xxx.csv

❓ 有以下不确定点需要确认：
1. [列出识别的 CPU/NPU 入口函数]
2. [列出测试用例覆盖情况]

请回复：
- "继续" - 进入规划阶段
- "调整 xxx" - 我会根据反馈修改并更新
- "查看 xxx" - 我会解释具体细节
```

**阶段 2 完成后：**
```
✅ 测试计划已生成：logs/test_op_plan.md

❓ 以下推断可能需要确认：
1. [执行模式推断：prefill/decode]
2. [形状覆盖范围]
3. [容差设置]

请回复：
- "批准" - 开始执行测试
- "调整 xxx" - 我会修改计划
- "增加 xxx 场景" - 我会补充用例
```

**阶段 3 完成后：**
```
✅ 测试完成：N/M 通过

📊 结果摘要：
- 通过率：xx%
- 失败用例：[列表]
- CSV：golden_results_xxx.csv
- 报告：logs/test_op_report.md

❓ 后续建议：
1. [根据失败情况的建议]

请回复：
- "完成" - 结束测试流程
- "重跑 xxx" - 针对特定 case 重测
- "查看 xxx" - 查看详细失败信息
```

---

## 反馈沉淀机制

用户的每次反馈都会被记录并更新到对应产物中：

| 用户反馈 | 沉淀位置 |
|---------|---------|
| 入口映射调整 | `test_<opname>.py` 的 import |
| 形状建议 | `logs/test_op_plan.md` 更新覆盖轴 |
| 容差调整 | `test_<opname>.py` 的 ATOL/RTOL |
| 场景补充 | `test_<opname>.py` 添加新测试函数 |
| 分支参数 | `logs/test_op_plan.md` 更新参数表 |

---

## 各阶段详细说明

### 阶段 1：重构

阅读：`.claude/skills/restructure-operator/SKILL.md`

- 分析原文件，识别 CPU/NPU 入口函数
- 生成 `test_<opname>.py`，直接 import 原函数
- 运行 Golden 验证
- 导出 CSV 校验结果

### 阶段 2：规划

阅读：`.claude/skills/plan-operator-test/SKILL.md`

- 基于参数说明推断执行模式
- 生成 prefill/decode 测试场景
- 设置覆盖轴与容差
- 输出 `logs/test_op_plan.md`

### 阶段 3：执行

阅读：`.claude/skills/execute-operator-test/SKILL.md`

- 运行 `test_<opname>.py`
- 收集测试结果
- 输出测试报告与 CSV

---

## 重要规则

1. **始终从重构开始** - 每个算子先经过重构
2. **不跳过阶段** - 按顺序：重构 → 规划 → 执行
3. **阶段之间等待用户确认**
4. **不确定的点主动询问用户**
5. **用户反馈沉淀到产物中**
