---
name: test-op
description: 算子精度测试入口 - 四阶段工作流
---

# 算子精度测试

> [!CAUTION]
> **必须前台交互式执行 - 禁止后台运行**
> 
> 执行此技能时必须：
> 1. 在前台逐步执行每个阶段
> 2. 每个阶段完成后**停止并等待用户确认**
> 3. 所有命令输出对用户可见
> 4. 用户可随时中断或提供反馈

---

## 工作流程

```
/test-op [算子文件]
    │
    ▼
┌─────────────────────────────────────┐
│  阶段 1：分析                        │
│  → /analyze-operator                 │
│  → 识别 CPU/NPU 入口 + 提取 __main__ │
│  → 🔴 展示分析结果，请求确认         │
└─────────────────────────────────────┘
    │ 用户确认 ✓
    ▼
┌─────────────────────────────────────┐
│  阶段 2：规划                        │
│  → /plan-and-confirm                 │
│  → 生成测试计划                      │
│  → 🔴 展示计划，请求批准             │
└─────────────────────────────────────┘
    │ 用户批准 ✓
    ▼
┌─────────────────────────────────────┐
│  阶段 3：编写与验证                  │
│  → /write-and-verify                 │
│  → 生成 test_<opname>.py             │
│  → 循环验证直至复现原 __main__ 测试   │
│  → 🔴 验证通过后请求确认             │
└─────────────────────────────────────┘
    │ 用户确认 ✓
    ▼
┌─────────────────────────────────────┐
│  阶段 4：扩展与报告                  │
│  → /extend-and-report                │
│  → 添加扩展用例，运行全部测试        │
│  → 导出 CSV，生成报告                │
│  → 🔴 展示结果                       │
└─────────────────────────────────────┘
```

---

## 各阶段职责

| 阶段 | Skill | 输出 |
|------|-------|------|
| 1. 分析 | `/analyze-operator` | `logs/analyze_result.md` |
| 2. 规划 | `/plan-and-confirm` | `logs/test_plan.md` |
| 3. 编写验证 | `/write-and-verify` | `test_<opname>.py` + `logs/verify_result.md` |
| 4. 扩展报告 | `/extend-and-report` | CSV + `logs/test_report.md` |

---

## 核心设计：输入抽象化

```python
# 测试文件结构
def make_inputs(**config):
    """统一输入构造，不同测试仅改变参数"""
    pass

def run_cpu(**config): ...
def run_npu(**config): ...

TEST_CONFIGS = [
    {"name": "baseline", ...},  # 复现 __main__
    {"name": "small", ...},     # 扩展用例
]
```

---

## 用户交互示例

### 阶段 1 完成后
```
📖 算子分析结果

入口函数：
- CPU: xxx_cpu(x, weight, bias)
- NPU: xxx_npu(x, weight, bias)

默认配置：batch=4, seq=128, hidden=256

❓ 请确认后继续规划阶段。
```

### 阶段 2 完成后
```
📋 测试计划

基础测试：复现 __main__
扩展测试：6 个用例

❓ 请批准或调整。
```

### 阶段 3 完成后
```
✅ Baseline 验证通过

测试文件：test_xxx.py
结果：PASS (max_diff=1.2e-7)

❓ 请确认后继续扩展测试。
```

### 阶段 4 完成后
```
✅ 测试完成：6/6 通过

📁 产物：
- CSV：results_xxx_20260205.csv
- 报告：logs/test_report.md

请回复 "完成" 结束。
```

---

## 重要规则

1. **按顺序执行**：分析 → 规划 → 编写验证 → 扩展报告
2. **每阶段等待用户确认**
3. **Baseline 必须先通过**：复现原 `__main__` 测试后才能扩展
4. **不确定的点主动询问用户**
5. **用户反馈沉淀到对应产物中**
6. **不修改目标算子代码** - 只修改测试文件
7. **对比推理修正** - 验证失败时，从原算子实现对比推理差异

---

## 产物汇总

| 产物 | 阶段 | 说明 |
|------|------|------|
| `logs/analyze_result.md` | 分析 | 分析结果 |
| `logs/test_plan.md` | 规划 | 测试计划 |
| `test_<opname>.py` | 编写验证 | 测试文件 |
| `logs/verify_result.md` | 编写验证 | 验证结果 |
| `results_<opname>_<ts>.csv` | 扩展报告 | 详细测试结果 |
| `logs/test_report.md` | 扩展报告 | 测试报告 |
