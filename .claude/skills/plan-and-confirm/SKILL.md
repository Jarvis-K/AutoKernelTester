---
name: plan-and-confirm
description: 规划测试范围并与用户确认
---

# 规划测试

**目的**：基于分析结果，规划测试范围，与用户确认后再执行。

---

## 前置条件

- 已完成 `/analyze-operator`

---

## 输出产物

- `logs/test_plan.md` - 详细测试计划

---

## 测试计划结构

### 1. 基础测试（必选）

**目标**：复现原 `__main__` 的测试结果，验证测试代码正确性

```yaml
baseline:
  name: "baseline"
  config: <从 __main__ 提取的默认配置>
  purpose: "复现原测试，确保一致后再扩展"
```

### 2. 扩展测试

| 类别 | 测试目的 | 配置变化 |
|------|---------|----------|
| 形状变化 | 覆盖不同 batch/seq/hidden | 小/典型/大 |
| 数据类型 | 覆盖 fp32/fp16/bf16 | dtype 变化 |
| 边界条件 | 测试边界值 | B=1, S=1 等 |
| 分支参数 | 覆盖 bool/enum 参数 | 各分支组合 |

### 3. 容差设置

| dtype | atol | rtol | 说明 |
|-------|------|------|------|
| fp32 | 1e-6 | 1e-6 | 默认 |
| fp16 | 1e-2 | 1e-2 | 半精度 |
| bf16 | 2e-2 | 2e-2 | BF16 |

---

## 用户交互

### 展示计划

```
📋 测试计划

基础测试（复现原 __main__）：
- config: batch=4, seq=128, hidden=256, dtype=fp32
- 容差: atol=1e-5

扩展测试：
1. 形状覆盖：
   - small: B=1, S=16, H=64
   - large: B=8, S=512, H=512
2. 数据类型：fp16, bf16
3. 边界测试：B=1, S=1

总计：N 个测试用例

❓ 请确认或调整：
- "批准" → 开始编写测试文件
- "增加 xxx 场景" → 补充用例
- "调整 seq_len 到 1024" → 修改配置
- "删除 bf16 测试" → 减少用例
```

### 更新计划

收到用户反馈后：
1. 更新 `logs/test_plan.md`
2. 重新展示计划
3. 再次请求确认

---

## logs/test_plan.md 格式

```markdown
# 测试计划：<算子名>

## 基础测试
- name: baseline
- config: {...}
- 容差: atol=1e-5, rtol=1e-5

## 扩展测试

### 形状覆盖
| 名称 | batch | seq | hidden |
|------|-------|-----|--------|
| small | 1 | 16 | 64 |
| large | 8 | 512 | 512 |

### 数据类型
- fp32 ✓
- fp16 ✓
- bf16 ✓

### 分支参数
| 参数 | 覆盖值 |
|------|--------|
| use_cache | [True, False] |

## 用户调整记录
- [时间] 用户要求增加 xxx 场景
- [时间] 用户要求调整容差
```

---

## 重要原则

> [!WARNING]
> **必须用户确认后才能继续下一阶段**
>
> 不要跳过确认步骤，规划阶段的目的就是与用户对齐测试范围
