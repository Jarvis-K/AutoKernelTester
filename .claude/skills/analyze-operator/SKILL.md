---
name: analyze-operator
description: åˆ†æç›®æ ‡ç®—å­æ–‡ä»¶ï¼Œæå–å…¥å£å‡½æ•°ï¼Œè¿è¡Œè·å–æœŸæœ›è¾“å‡º
---

# åˆ†æç®—å­

**ç›®çš„**ï¼šé˜…è¯»ç›®æ ‡ç®—å­æ–‡ä»¶ï¼Œæå–å…³é”®ä¿¡æ¯ï¼Œ**è¿è¡ŒåŸä»£ç è·å–æœŸæœ›è¾“å‡º**ã€‚

---

## è¾“å‡ºäº§ç‰©

- `logs/analyze_result.md` - åˆ†æç»“æœæ–‡æ¡£
- `logs/expected_output.json` - **æœŸæœ›è¾“å‡ºï¼ˆTDD åŸºå‡†ï¼‰**

---

## æ‰§è¡Œæ­¥éª¤

| æ­¥éª¤ | è¯´æ˜ |
|------|------|
| 1 | é˜…è¯»åŸç®—å­æ–‡ä»¶å®Œæ•´å†…å®¹ |
| 2 | è¯†åˆ« CPU/NPU å…¥å£å‡½æ•° |
| 3 | æå– `__main__` æµ‹è¯•é€»è¾‘ |
| 4 | **è¿è¡ŒåŸ `__main__`ï¼Œè·å–æœŸæœ›è¾“å‡º** |
| 5 | **ä¿å­˜æœŸæœ›è¾“å‡ºåˆ° `logs/expected_output.json`** |
| 6 | ç”Ÿæˆ `logs/analyze_result.md` |
| 7 | å±•ç¤ºåˆ†æç»“æœï¼Œè¯·æ±‚ç”¨æˆ·ç¡®è®¤ |

---

## TDD æ ¸å¿ƒï¼šè·å–æœŸæœ›è¾“å‡º

> [!IMPORTANT]
> **å…ˆè¿è¡Œï¼Œåæ¨ç†**
> 
> ä¸å‡è®¾è¾“å‡ºï¼Œç›´æ¥è¿è¡ŒåŸ `__main__` è·å–çœŸå®ç»“æœ

### è¿è¡ŒåŸä»£ç 

```bash
cd <ç®—å­ç›®å½•>
python <ç®—å­æ–‡ä»¶.py>
```

### ä¿å­˜æœŸæœ›è¾“å‡º

`logs/expected_output.json`:
```json
{
  "operator": "<opname>",
  "baseline_config": {
    "batch_size": 4,
    "seq_len": 128,
    "hidden_size": 256,
    "dtype": "float32"
  },
  "expected_results": {
    "cpu_shape": [4, 128, 256],
    "npu_shape": [4, 128, 256],
    "cpu_dtype": "torch.float32",
    "npu_dtype": "torch.float32",
    "max_diff": 1.23e-7,
    "original_pass": true
  },
  "sample_values": {
    "cpu_first_5": [0.123, -0.456, 0.789, -0.234, 0.567],
    "npu_first_5": [0.123, -0.456, 0.789, -0.234, 0.567]
  }
}
```

---

## éœ€æå–çš„ä¿¡æ¯

### 1. å…¥å£å‡½æ•°

```python
def xxx_cpu(...):    # CPU å®ç°
def xxx_npu(...):    # NPU å®ç°
```

### 2. `__main__` æµ‹è¯•é€»è¾‘

```python
if __name__ == "__main__":
    # è¾“å…¥æ„é€ æ–¹å¼
    # å‡½æ•°è°ƒç”¨æ–¹å¼
    # ç»“æœéªŒè¯é€»è¾‘
```

### 3. è¾“å…¥å‚æ•°æ˜ å°„

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | å«ä¹‰ |
|--------|------|--------|------|
| `batch_size` | int | ? | æ‰¹å¤§å° |
| `seq_len` | int | ? | åºåˆ—é•¿åº¦ |
| ... | ... | ... | ... |

---

## è¾“å‡ºæ ¼å¼

```
ğŸ“– ç®—å­åˆ†æç»“æœ

æ–‡ä»¶ï¼š<ç®—å­æ–‡ä»¶è·¯å¾„>

å…¥å£å‡½æ•°ï¼š
- CPU: xxx_cpu(x, weight, bias, ...)
- NPU: xxx_npu(x, weight, bias, ...)

__main__ æµ‹è¯•é€»è¾‘ï¼š
- è¾“å…¥æ„é€ ï¼štorch.randn(batch, seq, hidden)
- è°ƒç”¨æ–¹å¼ï¼šç›´æ¥è°ƒç”¨ xxx_cpu/xxx_npu
- éªŒè¯æ–¹æ³•ï¼štorch.allclose + max_diff

âœ… æœŸæœ›è¾“å‡ºï¼ˆå·²è¿è¡ŒéªŒè¯ï¼‰ï¼š
- CPU shape: [4, 128, 256]
- NPU shape: [4, 128, 256]
- max_diff: 1.23e-7
- åŸæµ‹è¯•ç»“æœ: PASS

â“ è¯·ç¡®è®¤åç»§ç»­è§„åˆ’é˜¶æ®µã€‚
```

---

## é˜²å¹»è§‰åŸåˆ™

> [!CAUTION]
> 1. **ä¸å‡è®¾å‚æ•°**ï¼šä»è¿è¡Œç»“æœåæ¨ï¼Œè€Œéä»ä»£ç æ¨æ–­
> 2. **ä¸å‡è®¾è¾“å‡º**ï¼šå¿…é¡»è¿è¡ŒåŸä»£ç è·å–æœŸæœ›å€¼
> 3. **ä¿ç•™è¯æ®**ï¼šæœŸæœ›å€¼ä¿å­˜åˆ° JSONï¼Œåç»­å¯è¿½æº¯
> 4. **åªè¯»ä¸æ”¹**ï¼šä¸ä¿®æ”¹åŸç®—å­æ–‡ä»¶
